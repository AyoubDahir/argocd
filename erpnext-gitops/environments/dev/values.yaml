erpnext:
  image:
    repository: frappe/erpnext
    tag: v15
    pullPolicy: IfNotPresent

  # Correct site name to match server directory "173.208.208.91"
  # This is CRITICAL for persistent site access.
  jobs:
    createSite:
      enabled: false  # Disable site creation, we have one
    migrate:
      enabled: false  # Manage migrations manually or via CI
      
  # Define the ingress
  ingress:
    enabled: false # Using NodePort for now per user setup? Or enable ingress? 
    # Current setup uses separate Ingress resource managed by user?
    # Let's keep it simple. Service Type NodePort is easier.

  # Service Configuration
  service:
    type: NodePort
    port: 8000
    externalPort: 30779 # Maps to the NodePort we are using

  # Persistence
  persistence:
    worker:
      enabled: true
      existingClaim: "erpnext-pvc" # Use the existing PVC to retain data
    logs:
      enabled: false # Disabled to avoid PVC issues, use kubectl logs instead
      size: 5Gi
      storageClass: "local-path"

  # Web/Gunicorn Configuration
  web:
    replicaCount: 1
    args:
      - /home/frappe/frappe-bench/env/bin/gunicorn
      - --chdir=/home/frappe/frappe-bench/sites
      - -b=0.0.0.0:8000
      - -w=2
      - -t=120
      - frappe.app:application
      - --preload

  # Worker Configuration
  worker:
    enabled: true
    # Provide env vars if needed
    
  # Scheduler Configuration
  scheduler:
    enabled: true

# Database Mirror (AWS Public ECR to avoid Docker Hub Rate Limits)
mariadb:
  image:
    registry: public.ecr.aws
    repository: bitnami/mariadb
    tag: 10.6.12-debian-11-r0

redis:
  image:
    registry: public.ecr.aws
    repository: bitnami/redis
    tag: 6.2.12-debian-11-r0

  # SocketIO
  socketio:
    enabled: true

  # Database
  dbHost: mariadb
  dbPort: 3306
  dbName: _173_208_208_91 # This might be the DB name derived from site? 
  # Actually, frappe connects via site_config.json. 
  # We just need to ensure env vars are set correctly.

  # Environment Variables for all pods
  # This is where we inject the site name
  env:
    - name: FRAPPE_SITE_NAME
      value: "173.208.208.91"
    - name: DB_HOST
      value: "mariadb"
    - name: DB_PORT
      value: "3306"
    - name: REDIS_CACHE
      value: "redis://redis:6379/0"
    - name: REDIS_QUEUE
      value: "redis://redis:6379/1"
    - name: REDIS_SOCKETIO
      value: "redis://redis:6379/2"
